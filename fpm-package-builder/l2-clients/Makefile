SHELL := /bin/bash

# ---------- COLORS ----------
GREEN  := \033[1;32m
RED    := \033[1;31m
BLUE   := \033[1;34m
YELLOW := \033[1;33m
RESET  := \033[0m

# ---------- EXCLUSIONS ----------
EXCLUDES := -not -path "./.git/*" \
            -not -path "*/.cache/*" \
            -not -path "*/.build/*" \
            -not -path "*/node_modules/*"

# ---------- FIND SUB-MAKEFILES ----------
SUBDIRS := $(shell find . -mindepth 2 -type f -name "Makefile" $(EXCLUDES) -exec dirname {} \; | sort)

.PHONY: default all clean %

# ---------- DEFAULT ----------
default: all

# ---------- WRAPPER TARGETS ----------
all clean:
	@$(MAKE) do-run TARGET=$@

%:
	@$(MAKE) do-run TARGET=$@

# ---------- MAIN EXECUTION ----------
do-run:
	@RESULT_FILE=$$(mktemp /tmp/make_results_XXXXXX.txt); \
	echo "$$RESULT_FILE" > /tmp/current_results_file; \
	printf "\nüîé $(BLUE)Running target '$(GREEN)$(TARGET)$(BLUE)' in all subdirs...$(RESET)\n\n"; \
	total_start=$$(date +%s.%N); \
	for dir in $(SUBDIRS); do \
	    start=$$(date +%s.%N); \
	    printf "üì¶ $(BLUE)Entering$(RESET) %s\n" "$$dir"; \
	    if $(MAKE) -s -C "$$dir" $(TARGET); then \
	        end=$$(date +%s.%N); \
	        elapsed=$$(printf "%.2f" $$(echo "$$end - $$start" | bc)); \
	        printf "   ‚úÖ $(GREEN)Success$(RESET) (%s) ‚Äî $(YELLOW)%ss$(RESET)\n\n" "$$dir" "$$elapsed"; \
	        echo "$$dir|SUCCESS|$$elapsed" >> "$$RESULT_FILE"; \
	    else \
	        end=$$(date +%s.%N); \
	        elapsed=$$(printf "%.2f" $$(echo "$$end - $$start" | bc)); \
	        printf "   ‚ùå $(RED)Error$(RESET) (%s) ‚Äî $(YELLOW)%ss$(RESET)\n\n" "$$dir" "$$elapsed"; \
	        echo "$$dir|ERROR|$$elapsed" >> "$$RESULT_FILE"; \
	    fi; \
	done; \
	total_end=$$(date +%s.%N); \
	total_elapsed=$$(printf "%.2f" $$(echo "$$total_end - $$total_start" | bc)); \
	printf "‚è±  $(BLUE)Total time: $(YELLOW)%ss$(RESET)\n\n" "$$total_elapsed"

	@$(MAKE) summary

# ---------- SUMMARY ----------
summary:
	@RESULT_FILE=$$(cat /tmp/current_results_file); \
	printf "$(BLUE)‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ SUMMARY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ$(RESET)\n"; \
	printf "%-40s %-10s %-10s\n" "Directory" "Result" "Time(s)"; \
	printf "%-40s %-10s %-10s\n" "----------------------------------------" "--------" "--------"; \
	while IFS="|" read -r dir result time; do \
	    if [ "$$result" = "SUCCESS" ]; then color="$(GREEN)"; symbol="‚úÖ"; else color="$(RED)"; symbol="‚ùå"; fi; \
	    printf "%-40s %-10b %-10s\n" "$$dir" "$$symbol $$color$$result$(RESET)" "$$time"; \
	done < "$$RESULT_FILE"; \
	printf "$(BLUE)‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ$(RESET)\n"