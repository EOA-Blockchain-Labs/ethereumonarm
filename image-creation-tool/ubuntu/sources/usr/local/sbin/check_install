#!/usr/bin/env bash
# ============================================================================
#  Ethereum on ARM - System Diagnostic Script (v3)
#  Combina simplicidad del script original + robustez y potencia del avanzado.
# ============================================================================

set -euo pipefail

# ------------------------------------------------------------
# DEFAULT SETTINGS
# ------------------------------------------------------------
USE_COLORS=true
SHOW_SUMMARY=true
SHOW_LOGS=false
LOG_FILE="/var/log/eoa_check.log"

# Output both to console and log
exec > >(tee -a "$LOG_FILE") 2>&1

# ------------------------------------------------------------
# ROOT CHECK
# ------------------------------------------------------------
if [ "$(id -u)" != "0" ]; then
    echo "Error: You must be root to run this script. Use sudo."
    exit 1
fi

# ------------------------------------------------------------
# OPTIONS
#   -n  disable colors
#   -s  skip summary
#   -l  show extended logs
# ------------------------------------------------------------
while getopts "nsl" opt; do
    case ${opt} in
        n) USE_COLORS=false ;;
        s) SHOW_SUMMARY=false ;;
        l) SHOW_LOGS=true ;;
        *) echo "Invalid option -$OPTARG" >&2; exit 1 ;;
    esac
done

# ------------------------------------------------------------
# COLORS
# ------------------------------------------------------------
if [ "$USE_COLORS" = true ]; then
    RED='\033[0;91m'; GREEN='\033[0;92m'; ORANGE='\033[0;33m'
    BOLD='\033[1m'; NC='\033[0m'
else
    RED=''; GREEN=''; ORANGE=''; BOLD=''; NC=''
fi

# ------------------------------------------------------------
# SUMMARY
# ------------------------------------------------------------
if [ "$SHOW_SUMMARY" = true ]; then
    echo -e "${BOLD}This script will check:${NC}"
    echo "- Hardware: board, RAM, disks, temperature"
    echo "- Network: IP, ports, connectivity, speed"
    echo "- System: OS, kernel, firewall, updates"
    echo "- Ethereum: EL/CL services, JWT, ports"
    echo "- Logs: processes, syslog, dmesg (optional)"
    echo
    read -rp "Continue? (y/n) " -n 1 -r; echo
    [[ "$REPLY" =~ ^[Yy]$ ]] || exit 1
fi

# ------------------------------------------------------------
# HELPERS
# ------------------------------------------------------------
section() {
    local title="$1"
    local line
    line=$(printf '%*s' "${COLUMNS:-$(tput cols)}" '' | tr ' ' '=')
    echo -e "\n${BOLD}$line${NC}"
    echo -e "${BOLD}# $title${NC}"
    echo -e "${BOLD}$line${NC}"
}
separator() { printf '%*s\n' "${COLUMNS:-$(tput cols)}" '' | tr ' ' -; }

# ------------------------------------------------------------
# DEPENDENCIES (minimal)
# ------------------------------------------------------------
MISSING=()
for cmd in awk bc curl jq nc ss free lscpu; do
    command -v "$cmd" >/dev/null || MISSING+=("$cmd")
done

if [ ${#MISSING[@]} -ne 0 ]; then
    echo -e "${ORANGE}Installing missing packages: ${MISSING[*]}${NC}"
    apt-get update -qq
    apt-get install -y "${MISSING[@]}"
fi

# ============================================================================
#  SECTION 1 — HARDWARE
# ============================================================================
section "HARDWARE"

# --- BOARD ---
separator
echo -e "${BOLD}Board Model:${NC}"
BOARD=$(tr -d '\0' </sys/firmware/devicetree/base/model 2>/dev/null || true)
[ -z "$BOARD" ] && BOARD=$(hostnamectl | awk -F: '/Model/ {print $2}' | xargs)
echo -e "$BOARD"

# --- RAM ---
separator
echo -e "${BOLD}RAM:${NC}"
RAM_GB=$(free -g | awk '/^Mem:/ {print $2}')
if [ "$RAM_GB" -lt 8 ]; then
    echo -e "RAM ${RED}FAIL${NC}: ${RAM_GB} GB"
elif [ "$RAM_GB" -eq 8 ]; then
    echo -e "RAM ${ORANGE}WARNING${NC}: 8 GB"
else
    echo -e "RAM ${GREEN}PASS${NC}: ${RAM_GB} GB"
fi

# --- DISKS ---
separator
echo -e "${BOLD}Disks:${NC}"
NVME=false; USB=false

if [ -b /dev/nvme0n1 ]; then
    NVME=true
    NVME_MODEL=$(tr -d '\0' </sys/class/block/nvme0n1/device/model)
fi

if [ -b /dev/sda ]; then
    USB=true
    USB_MODEL=$(tr -d '\0' </sys/class/block/sda/device/model)
fi

if $NVME || $USB; then
    echo -e "Disk Check ${GREEN}PASS${NC}"
else
    echo -e "${RED}No SSD/NVMe detected${NC}"
fi

$NVME && echo "NVMe: $NVME_MODEL"
$USB && echo "USB SSD: $USB_MODEL"

echo "Swap:"
swapon -s || true

# --- TEMPERATURE ---
separator
echo -e "${BOLD}Temperature:${NC}"
TEMP=$(awk '{printf "%.2f", $1/1000}' </sys/class/thermal/thermal_zone0/temp 2>/dev/null || echo "0")
echo "Board Temp: $TEMP°C"

# --- CPU ---
separator
echo -e "${BOLD}CPU:${NC}"
lscpu | grep "Model name" | sed 's/Model name:[ \t]*//' || echo "Unknown"
echo "Cores: $(nproc)"
echo "Load: $(uptime | awk -F'load average:' '{print $2}')"
echo "Uptime: $(uptime -p)"

# ============================================================================
#  SECTION 2 — NETWORK
# ============================================================================
section "NETWORK"

# --- LOCAL IP ---
separator
echo -e "${BOLD}Local Network:${NC}"
ip -4 addr show | grep inet || true

# --- PUBLIC IP ---
separator
echo -e "${BOLD}Public Network:${NC}"
PUB=$(curl -s ifconfig.co/json || echo "{}")
echo "Public IP: $(echo "$PUB" | jq -r '.ip')"
echo "ASN:       $(echo "$PUB" | jq -r '.asn')"
echo "Provider:  $(echo "$PUB" | jq -r '.asn_org')"

# --- PORTS ---
separator
echo -e "${BOLD}Forwarded Ports:${NC}"
for p in 30303 9000; do
    if nc -z "$(echo "$PUB" | jq -r '.ip')" "$p"; then
        echo -e "$p ${GREEN}open${NC}"
    else
        echo -e "$p ${RED}closed${NC}"
    fi
done

# --- SPEED TEST ---
separator
echo -e "${BOLD}Speedtest:${NC}"
if command -v speedtest-cli >/dev/null; then
    OUT=$(speedtest-cli --csv 2>/dev/null || true)
    if [ -n "$OUT" ]; then
        echo "Download: $(echo "$OUT" | awk -F, '{print $7}') bps"
        echo "Upload:   $(echo "$OUT" | awk -F, '{print $8}') bps"
    else
        echo -e "${ORANGE}Speedtest failed${NC}"
    fi
else
    echo -e "${ORANGE}speedtest-cli not installed${NC}"
fi

# ============================================================================
#  SECTION 3 — SYSTEM
# ============================================================================
section "SYSTEM"

separator
echo -e "${BOLD}OS & Kernel${NC}"
cat /etc/os-release
echo "Kernel: $(uname -r)"
echo "Arch:   $(uname -m)"

separator
echo -e "${BOLD}Firewall${NC}"
ufw status verbose || echo "UFW inactive"

separator
echo -e "${BOLD}Available Updates${NC}"
apt-get update -qq
apt-get --just-print upgrade | grep "^Inst" || echo "No updates"

separator
echo -e "${BOLD}Listening Ports${NC}"
ss -tunlp

# ============================================================================
#  SECTION 4 — ETHEREUM CLIENTS
# ============================================================================
section "ETHEREUM"

separator
echo -e "${BOLD}Clients Detected${NC}"

EXECUTION=(geth erigon besu nethermind reth ethrex nimbus-execution)
CONSENSUS=(lighthouse prysm teku nimbus lodestar grandine)
TESTNETS=(sepolia hoodi)
FOUND_EL=false; FOUND_CL=false

check_service() {
    systemctl is-active --quiet "$1" && { echo -e "${GREEN}$1 active${NC}"; return 0; }
    return 1
}

echo -e "${BOLD}Execution Layer:${NC}"
for base in "${EXECUTION[@]}"; do
    check_service "$base" && FOUND_EL=true
    for net in "${TESTNETS[@]}"; do check_service "${base}-${net}" && FOUND_EL=true; done
done

echo -e "\n${BOLD}Consensus Layer:${NC}"
for base in "${CONSENSUS[@]}"; do
    for s in beacon beacon-mev validator validator-mev; do
        check_service "${base}-${s}" && FOUND_CL=true
        for net in "${TESTNETS[@]}"; do check_service "${base}-${s}-${net}" && FOUND_CL=true; done
    done
done

$FOUND_EL || echo -e "${RED}No execution client found${NC}"
$FOUND_CL || echo -e "${RED}No consensus client found${NC}"

separator
JWT="/etc/ethereum/jwtsecret"
[ -s "$JWT" ] && echo -e "JWT ${GREEN}OK${NC}" || echo -e "${RED}JWT missing${NC}"

# ============================================================================
#  SECTION 5 — LOGS
# ============================================================================
section "LOGS"

separator
echo -e "${BOLD}Largest Log Files:${NC}"
find /var/log -type f -exec du -h {} + | sort -hr | head -n 10

if [ "$SHOW_LOGS" = true ]; then
    separator
    echo -e "${BOLD}Syslog (last 50)${NC}"
    tail -n 50 /var/log/syslog

    separator
    echo -e "${BOLD}dmesg (last 50)${NC}"
    dmesg -T | tail -n 50
fi

echo -e "${GREEN}Check completed.${NC}"
echo "Log saved to $LOG_FILE"

exit 0