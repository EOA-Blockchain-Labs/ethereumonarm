### ====================================================================
### UFW CONFIGURATION FOR ETHEREUM EXECUTION + CONSENSUS NODE (2025)
### ====================================================================
# Supports:
#   Execution: Geth, Nethermind, Besu, Erigon, Reth, EthRex
#   Consensus: Lighthouse, Teku, Prysm, Nimbus, Lodestar, Grandine
#
# Follows latest networking recommendations from official client docs.
# Goal: Secure Ethereum node while ensuring proper P2P connectivity.
#
# Default inbound: DROP
# Default outbound: ALLOW
# Only essential P2P + SSH open
# ====================================================================

*filter

# ---------------------------------------------------------------
# Internal UFW chains
# ---------------------------------------------------------------
:ufw-user-input - [0:0]
:ufw-user-output - [0:0]
:ufw-user-forward - [0:0]
:ufw-before-logging-input - [0:0]
:ufw-before-logging-output - [0:0]
:ufw-before-logging-forward - [0:0]
:ufw-user-logging-input - [0:0]
:ufw-user-logging-output - [0:0]
:ufw-user-logging-forward - [0:0]
:ufw-after-logging-input - [0:0]
:ufw-after-logging-output - [0:0]
:ufw-after-logging-forward - [0:0]
:ufw-logging-deny - [0:0]
:ufw-logging-allow - [0:0]
:ufw-user-limit - [0:0]
:ufw-user-limit-accept - [0:0]

# ---------------------------------------------------------------
# DEFAULT POLICIES
# ---------------------------------------------------------------
# Drop all incoming and forwarding by default
-A ufw-user-input -j DROP
-A ufw-user-forward -j DROP
# Allow all outgoing
-A ufw-user-output -j ACCEPT

# ---------------------------------------------------------------
# SSH ACCESS
# ---------------------------------------------------------------
-A ufw-user-input -p tcp --dport 22 -j ACCEPT
# Recommended: rate-limit SSH to protect against brute-force attacks
#   ufw limit 22/tcp comment 'Limit SSH connections'

# ---------------------------------------------------------------
# EXECUTION LAYER (EL) CLIENTS — P2P PORTS
# ---------------------------------------------------------------
# Default ports for major execution clients
#   Geth / Nethermind / Besu / Erigon / EthRex: 30303 TCP/UDP
#   Reth: 30304 TCP/UDP (configurable, sometimes same as 30303)

# Primary EL P2P
-A ufw-user-input -p tcp --dport 30303 -j ACCEPT
-A ufw-user-input -p udp --dport 30303 -j ACCEPT

# Alternative/Secondary (Reth)
-A ufw-user-input -p tcp --dport 30304 -j ACCEPT
-A ufw-user-input -p udp --dport 30304 -j ACCEPT

# ---------------------------------------------------------------
# CONSENSUS LAYER (CL) CLIENTS — P2P PORTS
# ---------------------------------------------------------------
# Default P2P Ports:
#   Lighthouse / Teku / Nimbus / Lodestar / Grandine: 9000 TCP+UDP
#   Lighthouse QUIC (UDP): 9001
#   Prysm: TCP 13000 / UDP 12000

# Common CL P2P (TCP + UDP)
-A ufw-user-input -p tcp --dport 9000 -j ACCEPT
-A ufw-user-input -p udp --dport 9000 -j ACCEPT

# Lighthouse QUIC (UDP)
-A ufw-user-input -p udp --dport 9001 -j ACCEPT

# Prysm
-A ufw-user-input -p tcp --dport 13000 -j ACCEPT
-A ufw-user-input -p udp --dport 12000 -j ACCEPT

# ---------------------------------------------------------------
# RPC / API ENDPOINTS (RESTRICTED ACCESS)
# ---------------------------------------------------------------
# These should remain closed to the public internet.
# Allow localhost or trusted IPs only.

# Execution layer (HTTP/WebSocket)
# -A ufw-user-input -p tcp --dport 8545 -s 127.0.0.1 -j ACCEPT
# -A ufw-user-input -p tcp --dport 8546 -s 127.0.0.1 -j ACCEPT

# Beacon node (REST/gRPC)
# -A ufw-user-input -p tcp --dport 5052 -s 127.0.0.1 -j ACCEPT

# Reth (engine API)
# -A ufw-user-input -p tcp --dport 8551 -s 127.0.0.1 -j ACCEPT

# EthRex (engine API)
# -A ufw-user-input -p tcp --dport 8550 -s 127.0.0.1 -j ACCEPT

# Optional external RPC (trusted IP only)
# -A ufw-user-input -p tcp --dport 8545 -s <YOUR_TRUSTED_IP> -j ACCEPT

# ---------------------------------------------------------------
# MONITORING / METRICS (OPTIONAL, LOCAL ONLY)
# ---------------------------------------------------------------
# Keep internal; restrict to localhost or private LAN

# Prometheus
# -A ufw-user-input -p tcp --dport 9090 -s 127.0.0.1 -j ACCEPT
# Node Exporter
# -A ufw-user-input -p tcp --dport 9100 -s 127.0.0.1 -j ACCEPT
# Grafana
# -A ufw-user-input -p tcp --dport 3000 -s 127.0.0.1 -j ACCEPT

# Metrics by client:
# -A ufw-user-input -p tcp --dport 8008 -s 127.0.0.1 -j ACCEPT  # Nimbus
# -A ufw-user-input -p tcp --dport 8009 -s 127.0.0.1 -j ACCEPT  # Teku
# -A ufw-user-input -p tcp --dport 8080 -s 127.0.0.1 -j ACCEPT  # Prysm
# -A ufw-user-input -p tcp --dport 5050 -s 127.0.0.1 -j ACCEPT  # Erigon
# -A ufw-user-input -p tcp --dport 6060 -s 127.0.0.1 -j ACCEPT  # Reth
# -A ufw-user-input -p tcp --dport 7301 -s 127.0.0.1 -j ACCEPT  # op-geth
# -A ufw-user-input -p tcp --dport 9300 -s 127.0.0.1 -j ACCEPT  # Lodestar

# ---------------------------------------------------------------
# LAYER 2 / ROLLUPS (OPTIONAL)
# ---------------------------------------------------------------
# Uncomment if running Optimism / Base / Arbitrum / OP Stack clients
# -A ufw-user-input -p tcp --dport 30403 -j ACCEPT  # op-geth P2P
# -A ufw-user-input -p udp --dport 30403 -j ACCEPT
# -A ufw-user-input -p tcp --dport 9222 -j ACCEPT   # op-node P2P
# -A ufw-user-input -p udp --dport 9222 -j ACCEPT

# ---------------------------------------------------------------
# PRIVATE LAN / CLUSTER ACCESS (OPTIONAL)
# ---------------------------------------------------------------
# Uncomment to allow Prometheus/Grafana/RPC access from internal subnet
# -A ufw-user-input -s 192.168.0.0/16 -j ACCEPT

# ---------------------------------------------------------------
# RATE LIMITING
# ---------------------------------------------------------------
-A ufw-user-limit -m limit --limit 3