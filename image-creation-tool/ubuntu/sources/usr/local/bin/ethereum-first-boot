#!/bin/bash
# Ethereum on ARM - Ansible Bootstrap Script
# This minimal script installs Ansible and runs the provisioning playbook.
# It is executed once on first boot by ethereum-first-boot.service.

set -e

# Configuration
FLAG="/root/first-run.flag"
ANSIBLE_DIR="/opt/ethereumonarm/ansible"
LOG_FILE="/var/log/ethereum-first-boot.log"

# Redirect all output to log file and console
exec > >(tee -a "${LOG_FILE}") 2>&1

echo "=============================================="
echo "Ethereum on ARM - First Boot Provisioning"
echo "Started at: $(date)"
echo "=============================================="

# Wait for network (polling)
MAX_RETRIES=30
echo "Waiting for network connectivity (max ${MAX_RETRIES}s)..."

for ((i=1; i<=MAX_RETRIES; i++)); do
  if wget -q --spider http://github.com; then
    echo "Network connection verified."
    break
  fi
  echo "Waiting for network... ($i/${MAX_RETRIES})"
  sleep 1
done

if (( i > MAX_RETRIES )); then
  echo "ERROR: No network connection after ${MAX_RETRIES} seconds. Cannot proceed."
  exit 1
fi

# Detect device model
echo "Detecting device model..."
DEVICE_MODEL=$(cat /sys/firmware/devicetree/base/model 2>/dev/null | tr -d '\0' || uname -m)
echo "Detected: ${DEVICE_MODEL}"

# Determine device type for Ansible variables
case "${DEVICE_MODEL}" in
  *"Raspberry Pi 5"*)
    DEVICE_TYPE="rpi5"
    ;;
  *"NanoPC-T6"*)
    DEVICE_TYPE="nanopct6"
    ;;
  *"ROCK 5B"*)
    DEVICE_TYPE="rock5b"
    ;;
  *"ROCK 5T"*)
    DEVICE_TYPE="rock5t"
    ;;
  *"Orange Pi 5 Plus"*)
    DEVICE_TYPE="orangepi5plus"
    ;;
  *)
    echo "WARNING: Unknown device model. Using defaults."
    DEVICE_TYPE="unknown"
    ;;
esac
echo "Device type: ${DEVICE_TYPE}"

# Install Ansible
echo "Installing Ansible..."
export DEBIAN_FRONTEND=noninteractive
apt-get update -qq
apt-get install -y ansible python3-jmespath || {
  echo "ERROR: Failed to install Ansible."
  exit 1
}
echo "Ansible installed: $(ansible --version | head -1)"

# Verify playbook exists
if [[ ! -f "${ANSIBLE_DIR}/playbook.yml" ]]; then
  echo "ERROR: Playbook not found at ${ANSIBLE_DIR}/playbook.yml"
  exit 1
fi

# Run Ansible playbook
echo "Running Ansible playbook..."
cd "${ANSIBLE_DIR}"

ansible-playbook \
  -i inventory.yml \
  playbook.yml \
  --connection=local \
  -v

ANSIBLE_EXIT=$?

if [[ ${ANSIBLE_EXIT} -ne 0 ]]; then
  echo "=============================================="
  echo "ERROR: Ansible playbook failed with exit code ${ANSIBLE_EXIT}"
  echo "The flag file was NOT created."
  echo "Provisioning will be RETRIED on next boot."
  echo "Check ${LOG_FILE} for details."
  echo "=============================================="
  exit ${ANSIBLE_EXIT}
fi

echo "=============================================="
echo "Provisioning completed successfully!"
echo "Finished at: $(date)"
echo "=============================================="

# Create flag file to prevent re-execution
touch "${FLAG}"

# Sync and reboot
echo "System will reboot in 10 seconds..."
sync
sleep 10
reboot
