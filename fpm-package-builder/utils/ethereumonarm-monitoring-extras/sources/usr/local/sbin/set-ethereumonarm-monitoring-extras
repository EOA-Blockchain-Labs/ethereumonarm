#!/usr/bin/env bash
set -euo pipefail

# Colors for logging
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

check_root() {
    if [[ $EUID -ne 0 ]]; then
       log_error "This script must be run as root"
       exit 1
    fi
}

check_files() {
    local files=(
        "/usr/lib/ethereumonarm/grafana.db"
        "/usr/lib/ethereumonarm/prometheus"
        "/usr/lib/ethereumonarm/prometheus-node-exporter"
        "/usr/lib/ethereumonarm/prometheus.yml"
    )

    for file in "${files[@]}"; do
        if [[ ! -f "$file" ]]; then
            log_error "Source file not found: $file"
            exit 1
        fi
    done
}

override() {
    log_info "Stopping monitoring services..."
    systemctl stop grafana-server prometheus prometheus-node-exporter || true

    # Stop and disable json-exporter service silently
    if systemctl is-active --quiet json-exporter; then
        systemctl stop json-exporter >/dev/null 2>&1 || true
    fi
    systemctl disable json-exporter >/dev/null 2>&1 || true

    # Configure Grafana
    log_info "Configuring Grafana..."
    cp /usr/lib/ethereumonarm/grafana.db /var/lib/grafana/grafana.db
    chown grafana:grafana /var/lib/grafana/grafana.db

    # Configure prometheus
    log_info "Configuring Prometheus..."
    cp /usr/lib/ethereumonarm/prometheus /etc/default/
    cp /usr/lib/ethereumonarm/prometheus-node-exporter /etc/default/
    cp /usr/lib/ethereumonarm/prometheus.yml /etc/prometheus/

    log_info "Starting monitoring services..."
    systemctl start grafana-server prometheus prometheus-node-exporter || true
    
    log_info "Configuration applied successfully."
}

confirm() {
    # call with a prompt string or use a default
    read -p "Return to default config, Are you sure? [y/N] " -n 1 -r REPLY
    echo "" # Print a newline after input

    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        log_info "Operation cancelled."
        exit 0
    else
        override
    fi
}

usage() {
    echo "Usage: $(basename "$0") [-o]"
    echo "  -o    Override configuration without asking for confirmation"
    exit 1
}

main() {
    check_root
    check_files

    local force=false

    while getopts 'oh' OPTION; do
        case "$OPTION" in
            o)
                force=true
                ;;
            h)
                usage
                ;;
            ?)
                usage
                ;;
        esac
    done

    if [[ "$force" == "true" ]]; then
        override
    else
        confirm
    fi
}

main "$@"
